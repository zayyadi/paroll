{% extends "base_new.html" %}
{% load humanize %}
{% load mathfilters %}

{% block page_title_in_head %}<title>HR/Admin Dashboard - Payroll System</title>{% endblock %}

{% block page_header %}HR/Admin Dashboard{% endblock %}

{% block extra_head %}
<!-- Chart.js for data visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Additional custom styles for dashboard -->
<style>
    .stat-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }
    
    .stat-card:hover::before {
        left: 100%;
    }
    
    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
    }
    
    .action-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }
    
    .action-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
    }
    
    .action-card:hover::after {
        transform: scaleX(1);
    }
    
    .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px -5px rgba(0, 0, 0, 0.1);
    }
    
    .quick-action-btn {
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }
    
    .quick-action-btn::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.4s, height 0.4s;
    }
    
    .quick-action-btn:hover::before {
        width: 300px;
        height: 300px;
    }
    
    .activity-item {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
    }
    
    .activity-item:hover {
        background-color: rgba(248, 250, 252, 0.8);
        border-left-color: #3b82f6;
        padding-left: calc(1rem + 3px);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .dark .gradient-bg {
        background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%);
    }
    
    .dark .gradient-text {
        background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="mb-8 animate-fade-in">
    <div class="gradient-bg rounded-2xl p-8 text-white shadow-soft">
        <div class="flex flex-col md:flex-row items-center justify-between">
            <div class="mb-4 md:mb-0">
                <h1 class="text-3xl font-bold mb-2">Welcome back, {{ user.first_name|default:user.email }}!</h1>
                <p class="text-white/80">Here's what's happening with your payroll today</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-center">
                    <p class="text-sm text-white/70">Current Date</p>
                    <p class="text-xl font-semibold">{% now "jS F Y" %}</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-white/70">Payroll Period</p>
                    <p class="text-xl font-semibold">{% now "F Y" %}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Employees Card -->
    <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <div class="bg-blue-100 dark:bg-blue-900/50 p-3 rounded-lg">
                <i data-lucide="users" class="h-6 w-6 text-blue-500"></i>
            </div>
        </div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Employees</h3>
        <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">{{ count }}</p>
        
    </div>
    
    <!-- Processed Payments Card -->
    <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-lg">
                <i data-lucide="credit-card" class="h-6 w-6 text-green-500"></i>
            </div>
            <span class="text-sm font-medium text-green-500 flex items-center">
                <i data-lucide="trending-up" class="h-4 w-4 mr-1"></i>
                {{percentage_increase|floatformat:"2"|intcomma}}%
            </span>
        </div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Processed Payments</h3>
        <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">{{ pay_count }}</p>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-gray-500 dark:text-gray-400">This month:</span>
            <span class="ml-2 font-medium text-gray-900 dark:text-white">${{ recent_month_total|floatformat:"2"|intcomma }}</span>
        </div>
    </div>
    
    <!-- Pending Approvals Card -->
    <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <div class="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-lg">
                <i data-lucide="clock" class="h-6 w-6 text-yellow-500"></i>
            </div>
            <span class="text-sm font-medium text-yellow-500 pulse-animation">3 new</span>
        </div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Pending Approvals</h3>
        <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">7</p>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-gray-500 dark:text-gray-400">Leave requests:</span>
            <span class="ml-2 font-medium text-gray-900 dark:text-white">{{ leave }}</span>
        </div>
    </div>
    
    <!-- Total Payroll Card -->
    <div class="stat-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <div class="flex items-center justify-between mb-4">
            <div class="bg-purple-100 dark:bg-purple-900/50 p-3 rounded-lg">
                <i data-lucide="dollar-sign" class="h-6 w-6 text-purple-500"></i>
            </div>
            <span class="text-sm font-medium text-green-500 flex items-center">
                <i data-lucide="trending-up" class="h-4 w-4 mr-1"></i>
                {{percentage_increase|floatformat:"2"|intcomma}}%
            </span>
        </div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Payroll</h3>
        <p class="text-3xl font-bold text-gray-900 dark:text-white mt-2">${{ pay_count|floatformat:"2"|intcomma }}</p>
        <div class="mt-4 flex items-center text-sm">
            <span class="text-gray-500 dark:text-gray-400">This month:</span>
            <span class="ml-2 font-medium text-gray-900 dark:text-white">${{ recent_month_total|floatformat:"2"|intcomma }}</span>
        </div>
        <div class="mt-2 flex items-center text-sm">
            <span class="text-gray-500 dark:text-gray-400">Payee (tax):</span>
            <span class="ml-2 font-medium text-gray-900 dark:text-white">${{ total_payee_paid|floatformat:"2"|intcomma }}</span>
        </div>
        <div class="mt-2 flex items-center text-sm">
            <span class="text-gray-500 dark:text-gray-400">Payee (net):</span>
            <span class="ml-2 font-medium text-gray-900 dark:text-white">${{ total_payee_net_paid|floatformat:"2"|intcomma }}</span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Payroll Trend Chart -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Payroll Trend</h3>
        <div class="chart-container">
            <canvas id="payrollTrendChart"></canvas>
        </div>
    </div>
    
    <!-- Department Distribution Chart -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Department Distribution</h3>
        <div class="chart-container">
            <canvas id="departmentChart"></canvas>
        </div>
    </div>
</div>

<!-- Quick Actions Toolbar -->
<div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm mb-8">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Actions</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <button class="quick-action-btn bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
            <i data-lucide="user-plus" class="h-6 w-6"></i>
            <span class="text-sm font-medium">Add Employee</span>
        </button>
        <button class="quick-action-btn bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
            <i data-lucide="file-plus" class="h-6 w-6"></i>
            <span class="text-sm font-medium">Generate Payslip</span>
        </button>
        <button class="quick-action-btn bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
            <i data-lucide="calendar-plus" class="h-6 w-6"></i>
            <span class="text-sm font-medium">Approve Leave</span>
        </button>
        <button class="quick-action-btn bg-yellow-500 hover:bg-yellow-600 text-white p-4 rounded-lg flex flex-col items-center justify-center space-y-2">
            <i data-lucide="download" class="h-6 w-6"></i>
            <span class="text-sm font-medium">Export Report</span>
        </button>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Action Cards -->
    <div class="lg:col-span-2 space-y-6">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Common Tasks</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Add Employee Card -->
            <a href="{% url 'payroll:add_employee' %}" class="block">
                <div class="action-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                    <div class="flex items-center space-x-4">
                        <div class="bg-indigo-100 dark:bg-indigo-900/50 p-3 rounded-lg">
                            <i data-lucide="user-plus" class="h-6 w-6 text-indigo-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900 dark:text-white">Add Employee</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Register new staff members</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 text-gray-400"></i>
                    </div>
                </div>
            </a>
            
            <!-- Process Payment Card -->
            <a href="{% url 'payroll:add_pay' %}" class="block">
                <div class="action-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                    <div class="flex items-center space-x-4">
                        <div class="bg-purple-100 dark:bg-purple-900/50 p-3 rounded-lg">
                            <i data-lucide="credit-card" class="h-6 w-6 text-purple-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900 dark:text-white">Process Payment</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Run payroll for employees</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 text-gray-400"></i>
                    </div>
                </div>
            </a>
            
            <!-- Generate Reports Card -->
            <a href="{% url 'payroll:payee' %}" class="block">
                <div class="action-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                    <div class="flex items-center space-x-4">
                        <div class="bg-green-100 dark:bg-green-900/50 p-3 rounded-lg">
                            <i data-lucide="file-text" class="h-6 w-6 text-green-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900 dark:text-white">Generate Reports</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Create tax and payroll reports</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 text-gray-400"></i>
                    </div>
                </div>
            </a>
            
            <!-- Manage Leave Card -->
            <a href="{% url 'payroll:leave_requests' %}" class="block">
                <div class="action-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                    <div class="flex items-center space-x-4">
                        <div class="bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-lg">
                            <i data-lucide="calendar" class="h-6 w-6 text-yellow-500"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-semibold text-lg text-gray-900 dark:text-white">Manage Leave</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Review and approve requests</p>
                        </div>
                        <i data-lucide="arrow-right" class="h-5 w-5 text-gray-400"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>
    
    <!-- Recent Activity Feed -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Recent Activity</h3>
        <div class="space-y-4">
            <div class="activity-item p-3 rounded-lg">
                <div class="flex items-start space-x-3">
                    <div class="bg-blue-100 dark:bg-blue-900/50 p-2 rounded-full">
                        <i data-lucide="user-plus" class="h-4 w-4 text-blue-500"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">New employee added</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">John Doe joined the team</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">2 hours ago</p>
                    </div>
                </div>
            </div>
            
            <div class="activity-item p-3 rounded-lg">
                <div class="flex items-start space-x-3">
                    <div class="bg-green-100 dark:bg-green-900/50 p-2 rounded-full">
                        <i data-lucide="check-circle" class="h-4 w-4 text-green-500"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Payment processed</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Monthly payroll completed</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">5 hours ago</p>
                    </div>
                </div>
            </div>
            
            <div class="activity-item p-3 rounded-lg">
                <div class="flex items-start space-x-3">
                    <div class="bg-yellow-100 dark:bg-yellow-900/50 p-2 rounded-full">
                        <i data-lucide="calendar" class="h-4 w-4 text-yellow-500"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Leave request</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Sarah Smith requested leave</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Yesterday</p>
                    </div>
                </div>
            </div>
            
            <div class="activity-item p-3 rounded-lg">
                <div class="flex items-start space-x-3">
                    <div class="bg-purple-100 dark:bg-purple-900/50 p-2 rounded-full">
                        <i data-lucide="file-text" class="h-4 w-4 text-purple-500"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Report generated</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Tax reports are ready</p>
                        <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">2 days ago</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upcoming Events Section -->
<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-8">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Upcoming Events</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="border-l-4 border-blue-500 pl-4">
            <h4 class="font-medium text-gray-900 dark:text-white">Payroll Processing</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">Next payroll run</p>
            <p class="text-sm font-medium text-blue-500 mt-1">In 3 days</p>
        </div>
        <div class="border-l-4 border-yellow-500 pl-4">
            <h4 class="font-medium text-gray-900 dark:text-white">Tax Deadline</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">Quarterly tax filing</p>
            <p class="text-sm font-medium text-yellow-500 mt-1">In 12 days</p>
        </div>
        <div class="border-l-4 border-green-500 pl-4">
            <h4 class="font-medium text-gray-900 dark:text-white">Performance Reviews</h4>
            <p class="text-sm text-gray-500 dark:text-gray-400">Q3 reviews due</p>
            <p class="text-sm font-medium text-green-500 mt-1">In 20 days</p>
        </div>
    </div>
</div>

<!-- Quick Links Section -->
<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Links</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="{% url 'payroll:iou_list' %}" 
           class="flex items-center p-4 space-x-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <div class="bg-red-100 dark:bg-red-900/50 p-2 rounded-lg">
                <i data-lucide="file-text" class="h-5 w-5 text-red-500"></i>
            </div>
            <div>
                <p class="font-medium text-gray-900 dark:text-white">IOU List</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">View pending IOUs</p>
            </div>
        </a>
        
        <a href="{% url 'payroll:leave_requests' %}" 
           class="flex items-center p-4 space-x-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <div class="bg-yellow-100 dark:bg-yellow-900/50 p-2 rounded-lg">
                <i data-lucide="calendar" class="h-5 w-5 text-yellow-500"></i>
            </div>
            <div>
                <p class="font-medium text-gray-900 dark:text-white">Leave Requests</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Manage time off</p>
            </div>
        </a>
        
        <a href="{% url 'payroll:appraisal_list' %}" 
           class="flex items-center p-4 space-x-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
            <div class="bg-teal-100 dark:bg-teal-900/50 p-2 rounded-lg">
                <i data-lucide="star" class="h-5 w-5 text-teal-500"></i>
            </div>
            <div>
                <p class="font-medium text-gray-900 dark:text-white">Performance Reviews</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">Employee evaluations</p>
            </div>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Initialize Payroll Trend Chart
    const payrollTrendCtx = document.getElementById('payrollTrendChart').getContext('2d');
    new Chart(payrollTrendCtx, {
        type: 'line',
        data: {
            labels: {{ pay_period_labels|safe }},
            datasets: [{
                label: 'Payroll Amount',
                data: {{ pay_period_data|safe }},
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // Initialize Department Distribution Chart
    const departmentCtx = document.getElementById('departmentChart').getContext('2d');
    const departmentLabels = {{ department_labels|safe }};
    const departmentCounts = {{ department_counts|safe }};
    
    // Generate colors dynamically based on number of departments
    const colors = [
        'rgba(59, 130, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(139, 92, 246, 0.8)',
        'rgba(236, 72, 153, 0.8)',
        'rgba(6, 182, 212, 0.8)',
        'rgba(249, 115, 22, 0.8)',
        'rgba(141, 15, 78, 0.8)',
        'rgba(140, 161, 20, 0.8)',
        'rgba(234, 88, 12, 0.8)'
    ];
    
    const backgroundColors = departmentLabels.map((_, index) => colors[index % colors.length]);
    
    new Chart(departmentCtx, {
        type: 'doughnut',
        data: {
            labels: departmentLabels,
            datasets: [{
                data: departmentCounts,
                backgroundColor: backgroundColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Add smooth scroll behavior
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Add number animation to statistics
    const animateValue = (element, start, end, duration) => {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            element.textContent = Math.floor(progress * (end - start) + start).toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    };
    
    // Animate statistics on page load
    const statNumbers = document.querySelectorAll('.stat-card p.text-3xl');
    statNumbers.forEach(stat => {
        const finalValue = parseInt(stat.textContent.replace(/[^0-9]/g, ''));
        if (!isNaN(finalValue)) {
            animateValue(stat, 0, finalValue, 1500);
        }
    });
});
</script>
{% endblock %}