{% extends "base_new.html" %}
{% load static %}

{% block page_header %}Create Pay Period{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Page Header -->
    <div class="bg-gradient-to-r from-primary-500 to-primary-600 rounded-2xl p-6 text-white shadow-medium mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-2xl font-bold mb-2">Create New Pay Period</h1>
                <p class="text-primary-100">Select employees to include in this payroll period</p>
            </div>
            <div class="mt-4 md:mt-0">
                <span class="bg-white bg-opacity-20 text-white text-sm font-medium px-4 py-2 rounded-full">
                    <i data-lucide="users" class="inline h-4 w-4 mr-1"></i>
                    <span id="totalEmployeesCount">{{ total_employees }}</span> Total Employees
                </span>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form method="post" action="{% url 'payroll:payday_create_new' %}" id="paydayForm" x-data="paydayForm()">
        {% csrf_token %}
        
        <!-- Hidden field for employee IDs -->
        <input type="hidden" name="payroll_payday" :value="selectedIdsString">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Panel: Employee Selection -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Search and Filter Bar -->
                <div class="bg-white rounded-xl shadow-soft p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Search -->
                        <div class="md:col-span-2 lg:col-span-2">
                            <label class="block text-sm font-medium text-secondary-700 mb-2">
                                <i data-lucide="search" class="inline h-4 w-4 mr-1"></i>
                                Search Employees
                            </label>
                            <input 
                                type="text" 
                                id="searchInput"
                                placeholder="Search by name, email, or employee ID..."
                                class="form-input w-full px-4 py-2.5 border border-secondary-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm"
                                x-model="searchQuery"
                                @input="filterEmployees()"
                            >
                        </div>

                        <!-- Department Filter -->
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-2">
                                <i data-lucide="building-2" class="inline h-4 w-4 mr-1"></i>
                                Department
                            </label>
                            <select 
                                id="departmentFilter"
                                class="form-input w-full px-4 py-2.5 border border-secondary-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm bg-white"
                                x-model="selectedDepartment"
                                @change="filterEmployees()"
                            >
                                <option value="">All Departments</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}">{{ dept.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Job Title Filter -->
                        <div>
                            <label class="block text-sm font-medium text-secondary-700 mb-2">
                                <i data-lucide="briefcase" class="inline h-4 w-4 mr-1"></i>
                                Job Title
                            </label>
                            <select 
                                id="jobTitleFilter"
                                class="form-input w-full px-4 py-2.5 border border-secondary-300 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-sm bg-white"
                                x-model="selectedJobTitle"
                                @change="filterEmployees()"
                            >
                                <option value="">All Job Titles</option>
                                {% for job_title in job_titles %}
                                <option value="{{ job_title.0 }}">{{ job_title.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Selection Actions -->
                    <div class="flex flex-wrap items-center justify-between mt-4 pt-4 border-t border-secondary-200">
                        <div class="flex items-center space-x-2">
                            <button 
                                type="button"
                                @click="selectAllFiltered()"
                                class="px-4 py-2 bg-primary-100 text-primary-700 rounded-lg text-sm font-medium hover:bg-primary-200 transition-colors"
                            >
                                <i data-lucide="check-square" class="inline h-4 w-4 mr-1"></i>
                                Select All Visible
                            </button>
                            <button 
                                type="button"
                                @click="deselectAll()"
                                class="px-4 py-2 bg-secondary-100 text-secondary-700 rounded-lg text-sm font-medium hover:bg-secondary-200 transition-colors"
                            >
                                <i data-lucide="square" class="inline h-4 w-4 mr-1"></i>
                                Deselect All
                            </button>
                        </div>
                        <div class="text-sm text-secondary-600">
                            <span x-text="selectedCount"></span> selected
                        </div>
                    </div>
                </div>

                <!-- Employee List -->
                <div class="bg-white rounded-xl shadow-soft overflow-hidden">
                    <!-- List Header -->
                    <div class="bg-secondary-50 px-6 py-3 border-b border-secondary-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <input 
                                    type="checkbox" 
                                    id="selectAllCheckbox"
                                    @change="toggleSelectAll($event)"
                                    class="h-4 w-4 text-primary-600 border-secondary-300 rounded focus:ring-primary-500"
                                >
                                <span class="text-sm font-medium text-secondary-700">Employee Name</span>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm font-medium text-secondary-700">
                                <span class="text-center">Department</span>
                                <span class="text-center">Job Title</span>
                                <span class="text-right">Net Pay</span>
                            </div>
                        </div>
                    </div>

                    <!-- Employee Items -->
                    <div id="employeeList" class="divide-y divide-secondary-200 max-h-[600px] overflow-y-auto">
                        <template x-for="employee in filteredEmployees" :key="employee.id">
                            <div 
                                class="employee-item px-6 py-4 hover:bg-secondary-50 transition-colors cursor-pointer"
                                :class="{ 'bg-primary-50': employee.selected }"
                                @click="toggleEmployee(employee)"
                            >
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4 flex-1">
                                        <input 
                                            type="checkbox" 
                                            :value="employee.id"
                                            :checked="employee.selected"
                                            @click.stop
                                            @change="toggleEmployee(employee)"
                                            class="h-4 w-4 text-primary-600 border-secondary-300 rounded focus:ring-primary-500"
                                        >
                                        <div class="flex-shrink-0">
                                            <template x-if="employee.photo && employee.photo !== 'default.png'">
                                                <img 
                                                    :src="employee.photo" 
                                                    :alt="employee.name"
                                                    class="h-10 w-10 rounded-full object-cover"
                                                >
                                            </template>
                                            <template x-if="!employee.photo || employee.photo === 'default.png'">
                                                <div 
                                                    class="h-10 w-10 rounded-full bg-primary-200 flex items-center justify-center text-primary-800 font-semibold text-sm"
                                                    x-text="employee.initials"
                                                ></div>
                                            </template>
                                        </div>
                                        <div>
                                            <p class="text-sm font-medium text-secondary-900" x-text="employee.name"></p>
                                            <p class="text-xs text-secondary-500" x-text="employee.email"></p>
                                            <p class="text-xs text-secondary-400" x-text="'ID: ' + employee.emp_id"></p>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-3 gap-4 flex-1 text-sm">
                                        <div class="text-center">
                                            <span class="text-secondary-600" x-text="employee.department"></span>
                                        </div>
                                        <div class="text-center">
                                            <span class="text-secondary-600" x-text="employee.job_title"></span>
                                        </div>
                                        <div class="text-right">
                                            <span class="font-medium text-secondary-900" x-text="'₦' + employee.net_pay"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <!-- Empty State -->
                        <div x-show="filteredEmployees.length === 0" class="py-12 text-center">
                            <i data-lucide="users" class="h-12 w-12 mx-auto text-secondary-400 mb-3"></i>
                            <p class="text-sm text-secondary-500">No employees found matching your criteria</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Pay Period Details -->
            <div class="space-y-6">
                <!-- Pay Period Info -->
                <div class="bg-white rounded-xl shadow-soft p-6">
                    <h2 class="text-lg font-semibold text-secondary-900 mb-4 flex items-center">
                        <i data-lucide="calendar" class="h-5 w-5 mr-2 text-primary-600"></i>
                        Pay Period Details
                    </h2>
                    
                    <div class="space-y-4">
                        <!-- Name -->
                        <div>
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-secondary-700 mb-2">
                                Pay Period Name <span class="text-danger-500">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <p class="mt-1 text-sm text-danger-600">{{ form.name.errors }}</p>
                            {% endif %}
                        </div>

                        <!-- Month -->
                        <div>
                            <label for="{{ form.paydays.id_for_label }}" class="block text-sm font-medium text-secondary-700 mb-2">
                                Month <span class="text-danger-500">*</span>
                            </label>
                            {{ form.paydays }}
                            {% if form.paydays.errors %}
                            <p class="mt-1 text-sm text-danger-600">{{ form.paydays.errors }}</p>
                            {% endif %}
                        </div>

                        <!-- Is Active -->
                        <div class="flex items-center">
                            <input 
                                type="checkbox" 
                                id="{{ form.is_active.id_for_label }}"
                                name="{{ form.is_active.name }}"
                                class="h-4 w-4 text-primary-600 border-secondary-300 rounded focus:ring-primary-500"
                                {% if form.is_active.value %}checked{% endif %}
                            >
                            <label for="{{ form.is_active.id_for_label }}" class="ml-2 text-sm text-secondary-700">
                                Mark as Active
                            </label>
                        </div>
                        {% if form.is_active.errors %}
                        <p class="mt-1 text-sm text-danger-600">{{ form.is_active.errors|striptags }}</p>
                        {% endif %}

                        <!-- Closed -->
                        <div class="flex items-center">
                            <input 
                                type="checkbox" 
                                id="{{ form.closed.id_for_label }}"
                                name="{{ form.closed.name }}"
                                class="h-4 w-4 text-primary-600 border-secondary-300 rounded focus:ring-primary-500"
                            >
                            <label for="{{ form.closed.id_for_label }}" class="ml-2 text-sm text-secondary-700">
                                Close for Editing
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Selection Summary -->
                <div class="bg-white rounded-xl shadow-soft p-6">
                    <h2 class="text-lg font-semibold text-secondary-900 mb-4 flex items-center">
                        <i data-lucide="bar-chart-2" class="h-5 w-5 mr-2 text-primary-600"></i>
                        Selection Summary
                    </h2>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-secondary-100">
                            <span class="text-sm text-secondary-600">Total Employees</span>
                            <span class="text-sm font-medium text-secondary-900">{{ total_employees }}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-secondary-100">
                            <span class="text-sm text-secondary-600">Selected</span>
                            <span class="text-sm font-medium text-primary-600" x-text="selectedCount"></span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-secondary-100">
                            <span class="text-sm text-secondary-600">Total Net Pay</span>
                            <span class="text-sm font-medium text-secondary-900" x-text="'₦' + totalNetPay.toLocaleString()"></span>
                        </div>
                        <div class="flex justify-between items-center py-2">
                            <span class="text-sm text-secondary-600">Departments</span>
                            <span class="text-sm font-medium text-secondary-900" x-text="selectedDepartments"></span>
                        </div>
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="bg-white rounded-xl shadow-soft p-6">
                    <div class="space-y-3">
                        <button 
                            type="submit"
                            id="createPayPeriodBtn"
                            class="w-full btn-primary text-white py-3 px-6 rounded-xl text-sm font-medium flex items-center justify-center"
                        >
                            <i data-lucide="save" class="h-4 w-4 mr-2"></i>
                            Create Pay Period
                        </button>
                        <a 
                            href="{% url 'payroll:pay_period_list' %}"
                            class="w-full block text-center py-3 px-6 border border-secondary-300 text-secondary-700 rounded-xl text-sm font-medium hover:bg-secondary-50 transition-colors"
                        >
                            Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div id="inactiveWarningModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-4">
    <div class="w-full max-w-md rounded-xl bg-white p-6 shadow-2xl">
        <h3 class="text-lg font-semibold text-secondary-900">Pay Period Not Active</h3>
        <p class="mt-2 text-sm text-secondary-600">
            You must check <strong>Mark as Active</strong> before creating a pay period.
        </p>
        <div class="mt-5 flex justify-end">
            <button type="button" id="closeInactiveWarningModal" class="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700">
                Okay
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();

    const form = document.getElementById('paydayForm');
    const isActiveCheckbox = document.getElementById('{{ form.is_active.id_for_label }}');
    const modal = document.getElementById('inactiveWarningModal');
    const closeModalBtn = document.getElementById('closeInactiveWarningModal');

    if (form && isActiveCheckbox && modal && closeModalBtn) {
        form.addEventListener('submit', function(event) {
            if (!isActiveCheckbox.checked) {
                event.preventDefault();
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        });

        closeModalBtn.addEventListener('click', function() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            isActiveCheckbox.focus();
        });
    }
});

// Alpine.js component for employee selection
function paydayForm() {
    return {
        employees: {{ employees_json|safe }},
        filteredEmployees: [],
        selectedIds: new Set(),
        searchQuery: '',
        selectedDepartment: '',
        selectedJobTitle: '',
        
        init() {
            this.filteredEmployees = [...this.employees];
            this.$watch('searchQuery', () => this.filterEmployees());
            this.$watch('selectedDepartment', () => this.filterEmployees());
            this.$watch('selectedJobTitle', () => this.filterEmployees());
        },
        
        get selectedCount() {
            return this.selectedIds.size;
        },
        
        get selectedIdsString() {
            return Array.from(this.selectedIds).join(',');
        },
        
        get totalNetPay() {
            let total = 0;
            this.selectedIds.forEach(id => {
                const emp = this.employees.find(e => e.id === id);
                if (emp) total += parseFloat(emp.net_pay);
            });
            return total;
        },
        
        get selectedDepartments() {
            const departments = new Set();
            this.selectedIds.forEach(id => {
                const emp = this.employees.find(e => e.id === id);
                if (emp && emp.department) departments.add(emp.department);
            });
            return departments.size;
        },
        
        filterEmployees() {
            this.filteredEmployees = this.employees.filter(emp => {
                const matchesSearch = !this.searchQuery || 
                    emp.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    emp.email.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    emp.emp_id.toLowerCase().includes(this.searchQuery.toLowerCase());
                
                const matchesDepartment = !this.selectedDepartment || 
                    emp.department_id === this.selectedDepartment;
                
                const matchesJobTitle = !this.selectedJobTitle || 
                    emp.job_title === this.selectedJobTitle;
                
                return matchesSearch && matchesDepartment && matchesJobTitle;
            });
        },
        
        toggleEmployee(employee) {
            if (this.selectedIds.has(employee.id)) {
                this.selectedIds.delete(employee.id);
                employee.selected = false;
            } else {
                this.selectedIds.add(employee.id);
                employee.selected = true;
            }
            this.updateForm();
        },
        
        selectAllFiltered() {
            this.filteredEmployees.forEach(emp => {
                this.selectedIds.add(emp.id);
                emp.selected = true;
            });
            this.updateForm();
        },
        
        deselectAll() {
            this.employees.forEach(emp => {
                this.selectedIds.delete(emp.id);
                emp.selected = false;
            });
            this.updateForm();
        },
        
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectAllFiltered();
            } else {
                this.deselectAll();
            }
        },
        
        updateForm() {
            // Update the hidden payroll_payday field
            const hiddenInput = document.querySelector('input[name="payroll_payday"]');
            if (hiddenInput) {
                hiddenInput.value = Array.from(this.selectedIds).join(',');
            }
        }
    }
}
</script>

<style>
.employee-item {
    transition: all 0.2s ease;
}

.employee-item:hover {
    background-color: rgba(248, 250, 252, 0.8);
}

.employee-item.bg-primary-50 {
    background-color: rgba(239, 246, 255, 0.5);
}

/* Custom scrollbar for employee list */
#employeeList::-webkit-scrollbar {
    width: 8px;
}

#employeeList::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
}

#employeeList::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 4px;
}

#employeeList::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}
