{% extends "base_new.html" %}

{% load static %}
{% load custom_tags %}

{% block title %}Notification Digests{% endblock %}

{% block page_header %}Notification Digests{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    {% if messages %}
        {% for message in messages %}
            <div class="mb-4 p-4 rounded-md flex items-start
                {% if message.tags == 'success' %}bg-success-50 text-success-800 border border-success-200
                {% elif message.tags == 'error' %}bg-danger-50 text-danger-800 border border-danger-200
                {% elif message.tags == 'warning' %}bg-warning-50 text-warning-800 border border-warning-200
                {% else %}bg-primary-50 text-primary-800 border border-primary-200{% endif %}">
                <i data-lucide="{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}alert-circle{% elif message.tags == 'warning' %}alert-triangle{% else %}info{% endif %}" 
                   class="h-5 w-5 mr-3 flex-shrink-0"></i>
                <span class="text-sm">{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Introduction -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4 mb-6">
        <div class="flex items-start space-x-3">
            <i data-lucide="inbox" class="h-5 w-5 text-blue-600 dark:text-blue-400 flex-shrink-0 mt-0.5"></i>
            <div>
                <h3 class="text-sm font-medium text-blue-900 dark:text-blue-100">Notification Digests</h3>
                <p class="text-sm text-blue-700 dark:text-blue-300 mt-1">
                    Manage your digest preferences and view past digest notifications. Digests help reduce notification clutter by grouping multiple notifications.
                </p>
            </div>
        </div>
    </div>

    <!-- Digest Settings -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700 mb-6">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Digest Settings</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Configure when to receive digest emails</p>
        </div>
        <div class="px-6 py-4">
            <form method="post" action="{% url 'payroll:notification_digest_settings' %}">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Daily Digest -->
                    <div class="flex items-start justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center">
                                    <i data-lucide="sun" class="h-5 w-5 text-blue-600 dark:text-blue-400"></i>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 dark:text-white">Daily Digest</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Receive a daily summary at 8 AM</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer mt-1">
                            <input type="checkbox" name="daily_digest_enabled" class="sr-only peer"
                                   {% if preferences.email_digest_frequency == 'daily' %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <!-- Weekly Digest -->
                    <div class="flex items-start justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center">
                                    <i data-lucide="calendar" class="h-5 w-5 text-purple-600 dark:text-purple-400"></i>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 dark:text-white">Weekly Digest</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Receive a weekly summary on Mondays</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer mt-1">
                            <input type="checkbox" name="weekly_digest_enabled" class="sr-only peer"
                                   {% if preferences.email_digest_frequency == 'weekly' %}checked{% endif %}>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                </div>

                <div class="mt-4 flex justify-end">
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i data-lucide="save" class="h-4 w-4 inline mr-1.5"></i>
                        Save Digest Settings
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Past Digests -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Past Digests</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">View previously sent notification digests</p>
                </div>
                <button onclick="triggerManualDigest()" class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                    <i data-lucide="send" class="h-4 w-4 mr-1.5"></i>
                    Send Now
                </button>
            </div>
        </div>

        <div class="divide-y divide-gray-200 dark:divide-gray-700">
            {% if digests %}
                {% for digest in digests %}
                    <div class="px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4 flex-1">
                                <!-- Icon -->
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 rounded-full flex items-center justify-center
                                        {% if digest.frequency == 'daily' %}bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-400
                                        {% elif digest.frequency == 'weekly' %}bg-purple-100 dark:bg-purple-900/50 text-purple-600 dark:text-purple-400
                                        {% else %}bg-gray-100 dark:bg-gray-900/50 text-gray-600 dark:text-gray-400{% endif %}">
                                        <i data-lucide="{% if digest.frequency == 'daily' %}sun{% elif digest.frequency == 'weekly' %}calendar{% else %}inbox{% endif %}" 
                                           class="h-5 w-5"></i>
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2">
                                        <h3 class="text-sm font-semibold text-gray-900 dark:text-white">
                                            {% if digest.frequency == 'daily' %}Daily Digest{% elif digest.frequency == 'weekly' %}Weekly Digest{% else %}Notification Digest{% endif %}
                                        </h3>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
                                            {% if digest.frequency == 'daily' %}bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-200
                                            {% elif digest.frequency == 'weekly' %}bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-200
                                            {% else %}bg-gray-100 text-gray-800 dark:bg-gray-900/50 dark:text-gray-200{% endif %}">
                                            {{ digest.notification_count }} notifications
                                        </span>
                                    </div>
                                    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                                        Digest for {{ digest.date|date:"F j, Y" }}
                                    </p>
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-500">
                                        Sent {{ digest.sent_at|timesince }} ago
                                    </p>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center space-x-2 ml-4">
                                <a href="{% url 'payroll:notification_digest_detail' digest.id %}" 
                                   class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <i data-lucide="eye" class="h-4 w-4 mr-1.5"></i>
                                    View
                                </a>
                                <button onclick="toggleDigest({{ digest.id }})" 
                                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                    <i data-lucide="{% if digest.is_enabled %}bell-off{% else %}bell{% endif %}" 
                                       class="h-4 w-4 mr-1.5"></i>
                                    {% if digest.is_enabled %}Disable{% else %}Enable{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="px-6 py-12 text-center">
                    <i data-lucide="inbox" class="h-16 w-16 text-gray-400 mx-auto mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">No digests yet</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400">
                        Digests will appear here once they are generated.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Back to Notifications -->
    <div class="mt-6">
        <a href="{% url 'payroll:notifications' %}" 
           class="inline-flex items-center text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white">
            <i data-lucide="arrow-left" class="h-4 w-4 mr-1"></i>
            Back to Notifications
        </a>
    </div>
</div>

<script>
function triggerManualDigest() {
    if (!confirm('Send a manual digest now? This will send a digest of all unread notifications.')) return;
    
    fetch('{% url "payroll:trigger_manual_digest" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to send digest'));
        }
    })
    .catch(error => {
        console.error('Error sending digest:', error);
        alert('Failed to send digest. Please try again.');
    });
}

function toggleDigest(digestId) {
    fetch(`/payroll/notifications/digests/${digestId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    })
    .catch(error => console.error('Error toggling digest:', error));
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
