{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="{{ APP_LOGO_URL }}">
    <link rel="shortcut icon" href="{{ APP_LOGO_URL }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" as="style">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        warning: {
                            50: '#fffbeb',
                            100: '#fef3c7',
                            200: '#fde68a',
                            300: '#fcd34d',
                            400: '#fbbf24',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            200: '#fecaca',
                            300: '#fca5a5',
                            400: '#f87171',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 2px 15px -3px rgba(0, 0, 0, 0.07), 0 10px 20px -2px rgba(0, 0, 0, 0.04)',
                        'medium': '0 4px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        [x-cloak] {
            display: none !important;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .sidebar-link {
            transition: all 0.2s ease;
        }

        .sidebar-link:hover {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            padding-left: calc(1rem - 3px);
        }

        .sidebar-link.active {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
            padding-left: calc(1rem - 3px);
            color: #3b82f6;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .form-input {
            transition: all 0.2s ease;
        }

        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .table-row-hover:hover {
            background-color: rgba(248, 250, 252, 0.8);
        }

        .notification {
            animation: slideUp 0.3s ease-out;
        }
    </style>
    {% block page_title_in_head %}<title>{{ APP_NAME }} - {{ APP_TAGLINE }}</title>{% endblock %}
    {% block extra_head %}{% endblock %}
</head>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<body x-data="{ sidebarOpen: false, notificationsOpen: false }" x-init="sidebarOpen = false; notificationsOpen = false"
    @keydown.escape.window="sidebarOpen = false; notificationsOpen = false"
    class="bg-gray-50 text-secondary-800 min-h-screen">

    <!-- Top Navigation -->
    <nav class="bg-white shadow-soft fixed top-0 left-0 right-0 z-50">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left side: Logo and Mobile menu button -->
                <div class="flex items-center">
                    <!-- Mobile menu button -->
                    <button @click="sidebarOpen = !sidebarOpen"
                        class="md:hidden p-2 rounded-md text-secondary-600 hover:text-secondary-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500">
                        <span class="sr-only">Open sidebar</span>
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>

                    <!-- Logo -->
                    <a href="{% url 'payroll:index' %}" class="flex items-center ml-2 md:ml-0">
                        <div class="flex-shrink-0 flex items-center">
                            <img src="{{ APP_LOGO_URL }}" alt="{{ APP_NAME }} logo" class="h-8 w-auto">
                            <span class="ml-2 text-xl font-bold text-secondary-900">{{ APP_NAME }}</span>
                        </div>
                    </a>
                </div>

                <!-- Right side: User menu and notifications -->
               <div class="flex items-center space-x-4">
    {% if user.is_authenticated and current_company %}
    <span class="hidden lg:inline-flex items-center px-3 py-1 rounded-full bg-primary-50 text-primary-700 text-xs font-semibold">
        <i data-lucide="building-2" class="h-3.5 w-3.5 mr-1"></i>
        {{ current_company.name }}
    </span>
    {% endif %}
    <!-- Notifications -->
    {% if user.is_authenticated %}
    <button @click="loadNotifications(); notificationsOpen = !notificationsOpen"
        class="relative p-2 rounded-full text-secondary-600 hover:text-secondary-900 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500">
        <span class="sr-only">View notifications</span>
        <i data-lucide="bell" class="h-6 w-6"></i>
        <span id="notificationBadge" class="notification-badge absolute top-0 right-0 hidden flex items-center justify-center h-5 w-5 rounded-full bg-danger-500 text-white text-xs font-bold">0</span>
    </button>

    <!-- Notifications dropdown -->
    <div x-show="notificationsOpen" x-cloak
        @click.away="notificationsOpen = false"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition ease-in duration-75"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-95"
        class="origin-top-right absolute right-0 mt-2 w-80 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none z-50"
        style="top: 3.5rem;">
        <div id="notificationDropdownContent">
            <!-- Notifications will be loaded here -->
        </div>
    </div>
    {% endif %}

    <!-- User dropdown -->
    <div x-data="{ open: false }" @click.away="open = false" class="relative">
        {% if user.is_authenticated %}
        <button @click="open = !open"
            class="flex items-center space-x-3 p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500">
            {% if user.employee_user.photo %}
            <img class="h-8 w-8 rounded-full object-cover" src="{{ user.employee_user.photo.url }}"
                alt="User Avatar">
            {% else %}
            <div
                class="h-8 w-8 rounded-full bg-primary-200 flex items-center justify-center text-primary-800 font-semibold text-sm">
                {{ user.first_name|first|default:user.email|first|upper }}
            </div>
            {% endif %}
            <span class="hidden md:block text-sm font-medium text-secondary-700">{{ user.first_name|default:user.email }}</span>
            <i data-lucide="chevron-down" class="h-4 w-4 text-secondary-500"></i>
        </button>

        <!-- User dropdown menu -->
        <div x-show="open" x-cloak
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform scale-95"
            x-transition:enter-end="opacity-100 transform scale-100"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="opacity-100 transform scale-100"
            x-transition:leave-end="opacity-0 transform scale-95"
            class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none z-50">
            <div class="py-1">
                <a href="{% url 'payroll:profile' user.id %}"
                    class="block px-4 py-2 text-sm text-secondary-700 hover:bg-gray-100">Your
                    Profile</a>
                <a href="{% url 'users:settings' %}"
                    class="block px-4 py-2 text-sm text-secondary-700 hover:bg-gray-100">Account
                    Settings</a>
                <a href="{% url 'users:password' %}"
                    class="block px-4 py-2 text-sm text-secondary-700 hover:bg-gray-100">Change
                    Password</a>
                <a href="{% url 'users:logout' %}"
                    class="block px-4 py-2 text-sm text-secondary-700 hover:bg-gray-100">Sign out</a>
            </div>
        </div>
        {% else %}
        <a href="{% url 'users:login' %}"
            class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">Login</a>
        {% endif %}
    </div>
</div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile sidebar -->
    <div x-show="sidebarOpen" class="md:hidden fixed inset-0 z-40" x-cloak>
        <!-- Backdrop -->
        <div x-show="sidebarOpen" @click="sidebarOpen = false"
            x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-linear duration-300"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-secondary-600 bg-opacity-75"></div>

        <!-- Sidebar -->
        <div x-show="sidebarOpen" x-transition:enter="transition ease-in-out duration-300 transform"
            x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in-out duration-300 transform" x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-full"
            class="relative flex-1 flex flex-col max-w-xs w-full bg-white pt-5 pb-4">
            <div class="absolute top-0 right-0 -mr-12 pt-2">
                <button x-show="sidebarOpen" @click="sidebarOpen = false"
                    class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                    <span class="sr-only">Close sidebar</span>
                    <i data-lucide="x" class="h-6 w-6 text-white"></i>
                </button>
            </div>

            <!-- Sidebar content -->
            <div class="flex-1 h-0 overflow-y-auto">
                <nav class="px-2 space-y-1">
                    <a href="{% url 'payroll:index' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="home"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Dashboard
                    </a>
                    {% if request.user.is_superuser or request.user.is_staff %}
                    <a href="{% url 'payroll:employee_list' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="users"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Employees
                    </a>
                    {% endif %}
                    <a href="{% url 'payroll:profile' request.user.id %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="user"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        My Profile
                    </a>
                    <a href="{% url 'payroll:bank' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="credit-card"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Banking
                    </a>
                    <a href="{% url 'payroll:payee' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="file-text"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Tax Reports
                    </a>
                    {% if request.user.is_superuser or request.user.is_staff %}
                    <a href="{% url 'payroll:hr_dashboard' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="bar-chart-2"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        HR Dashboard
                    </a>
                    <a href="{% url 'payroll:payday_create_new' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="calendar-plus"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Create Pay Period
                    </a>
                    <a href="{% url 'payroll:payvar_create_new' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="settings"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Create Payroll Variables
                    </a>
                    {% endif %}
                    <a href="{% url 'payroll:appraisal_list' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="star"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Performance Reviews
                    </a>
                    <a href="{% url 'payroll:standup_dashboard' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="message-square"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Standup
                    </a>
                    <a href="{% url 'payroll:leave_requests' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="calendar"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Leave Requests
                    </a>
                    <a href="{% url 'users:settings' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="settings"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        Account Settings
                    </a>
                    {% if not request.user.is_superuser and not request.user.is_staff %}
                    <a href="{% url 'payroll:my_iou_tracker' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-base font-medium rounded-md">
                        <i data-lucide="wallet"
                            class="mr-4 h-6 w-6 text-secondary-400 group-hover:text-secondary-500"></i>
                        My IOU Tracker
                    </a>
                    {% endif %}
                    {% if request.user.is_authenticated and multi_company_enabled %}
                    <div class="px-3 py-3 mt-3 border-t border-secondary-200">
                        <p class="text-xs font-semibold text-secondary-500 uppercase tracking-wide">Company</p>
                        <p class="mt-2 text-sm text-secondary-700">{{ current_company.name|default:"No active company" }}</p>
                        {% if can_switch_company %}
                        <div class="mt-2 space-y-2">
                            {% for company in user_companies %}
                            {% if current_company and company.id != current_company.id %}
                            <form method="post" action="{% url 'users:switch_company' company.id %}">
                                {% csrf_token %}
                                <button type="submit"
                                    class="w-full text-left text-xs text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-md px-2 py-1.5">
                                    Switch to {{ company.name }}
                                </button>
                            </form>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>

    <!-- Desktop sidebar -->
    <div class="hidden md:flex md:w-64 md:flex-col md:fixed md:inset-y-0">
        <div class="flex flex-col flex-grow pt-16 bg-white border-r border-gray-200 overflow-y-auto">
            <div class="flex-grow flex flex-col">
                <nav class="flex-1 px-2 py-4 space-y-1">
                    <a href="{% url 'payroll:index' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="home"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Dashboard
                    </a>
                    {% if request.user.is_superuser or request.user.is_staff %}
                    <a href="{% url 'payroll:employee_list' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="users"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Employees
                    </a>
                    {% endif %}
                    <a href="{% url 'payroll:profile' request.user.id %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="user"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        My Profile
                    </a>
                    <a href="{% url 'payroll:bank' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="credit-card"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Banking
                    </a>
                    <a href="{% url 'payroll:payee' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="file-text"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Tax Reports
                    </a>
                    {% if request.user.is_superuser or request.user.is_staff %}
                    <a href="{% url 'payroll:hr_dashboard' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="bar-chart-2"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        HR Dashboard
                    </a>
                    <a href="{% url 'payroll:payday_create_new' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="calendar-plus"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Create Pay Period
                    </a>
                    <a href="{% url 'payroll:payvar_create_new' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="settings"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Create Payroll Variables
                    </a>
                    {% endif %}
                    <a href="{% url 'payroll:appraisal_list' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="star"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Performance Reviews
                    </a>
                    <a href="{% url 'payroll:standup_dashboard' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="message-square"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Standup
                    </a>
                    <a href="{% url 'payroll:leave_requests' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="calendar"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Leave Requests
                    </a>
                    <a href="{% url 'users:settings' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="settings"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        Account Settings
                    </a>
                    {% if not request.user.is_superuser and not request.user.is_staff %}
                    <a href="{% url 'payroll:my_iou_tracker' %}"
                        class="sidebar-link group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i data-lucide="wallet"
                            class="mr-3 h-5 w-5 text-secondary-400 group-hover:text-secondary-500"></i>
                        My IOU Tracker
                    </a>
                    {% endif %}
                    {% if request.user.is_authenticated and multi_company_enabled %}
                    <div class="px-2 py-3 mt-3 border-t border-secondary-200">
                        <p class="text-xs font-semibold text-secondary-500 uppercase tracking-wide">Company</p>
                        <p class="mt-2 text-sm text-secondary-700">{{ current_company.name|default:"No active company" }}</p>
                        {% if can_switch_company %}
                        <div class="mt-2 space-y-2">
                            {% for company in user_companies %}
                            {% if current_company and company.id != current_company.id %}
                            <form method="post" action="{% url 'users:switch_company' company.id %}">
                                {% csrf_token %}
                                <button type="submit"
                                    class="w-full text-left text-xs text-primary-700 bg-primary-50 hover:bg-primary-100 rounded-md px-2 py-1.5">
                                    Switch to {{ company.name }}
                                </button>
                            </form>
                            {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </nav>
            </div>
        </div>
    </div>

    <!-- Main content -->
    <div class="md:pl-64 flex flex-col flex-1">
        <main class="flex-1 pt-16">
            <div class="py-6">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
                    <!-- Page header -->
                    <div class="mb-6">
                        <h1 class="text-2xl font-bold text-secondary-900">{% block page_header %}{% endblock %}</h1>
                        {% block breadcrumbs %}{% endblock %}
                    </div>

                    <!-- Flash messages -->
                    {% if messages %}
                    <div class="mb-6 space-y-2">
                        {% for message in messages %}
                        <div x-data="{ show: true }" x-show="show" x-transition:enter="transition ease-out duration-300"
                            x-transition:enter-start="opacity-0 transform translate-y-2"
                            x-transition:enter-end="opacity-100 transform translate-y-0"
                            x-transition:leave="transition ease-in duration-200"
                            x-transition:leave-start="opacity-100 transform translate-y-0"
                            x-transition:leave-end="opacity-0 transform translate-y-2"
                            class="notification rounded-md p-4 flex items-start
                            {% if message.tags == 'success' %}bg-success-50 text-success-800 border border-success-200{% endif %}
                            {% if message.tags == 'error' %}bg-danger-50 text-danger-800 border border-danger-200{% endif %}
                            {% if message.tags == 'info' %}bg-primary-50 text-primary-800 border border-primary-200{% endif %}
                            {% if message.tags == 'warning' %}bg-warning-50 text-warning-800 border border-warning-200{% endif %}">

                            <div class="flex-shrink-0 mr-3">
                                {% if message.tags == 'success' %}<i data-lucide="check-circle"
                                    class="h-5 w-5 text-success-600"></i>{% endif %}
                                {% if message.tags == 'error' %}<i data-lucide="alert-circle"
                                    class="h-5 w-5 text-danger-600"></i>{% endif %}
                                {% if message.tags == 'info' %}<i data-lucide="info"
                                    class="h-5 w-5 text-primary-600"></i>{% endif %}
                                {% if message.tags == 'warning' %}<i data-lucide="alert-triangle"
                                    class="h-5 w-5 text-warning-600"></i>{% endif %}
                            </div>
                            <div class="flex-grow text-sm">{{ message }}</div>
                            <div class="ml-3">
                                <button @click="show = false" type="button"
                                    class="inline-flex text-secondary-400 hover:text-secondary-600 focus:outline-none">
                                    <span class="sr-only">Dismiss</span>
                                    <i data-lucide="x" class="h-4 w-4"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Page content -->
                    {% block content %}{% endblock %}
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 md:px-8">
                <p class="text-center text-sm text-secondary-500">
                    Â© {% now "Y" %} {{ APP_NAME }}. All rights reserved.
                </p>
            </div>
        </footer>
    </div>

    <!-- Initialize Lucide icons -->
    <script>
    (function() {
        'use strict';
        
        // Debounce function to limit how often a function can be called
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Initialize Lucide icons once
        function initializeIcons() {
            if (typeof lucide !== 'undefined') {
                try {
                    lucide.createIcons();
                } catch (error) {
                    console.error('Error initializing Lucide icons:', error);
                }
            }
        }
        
        // Debounced icon initialization for dynamic content
        const debouncedIconInit = debounce(initializeIcons, 100);
        
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize icons once when DOM is ready
            initializeIcons();
            
            // Load notification count
            loadNotificationCount();
        });
        
        // Optimized MutationObserver - only watch specific containers that might have dynamic content
        // Instead of watching the entire body, we'll only watch the notification dropdown
        function setupIconObserver() {
            const notificationDropdown = document.getElementById('notificationDropdownContent');
            if (notificationDropdown) {
                const observer = new MutationObserver(debouncedIconInit);
                observer.observe(notificationDropdown, {
                    childList: true,
                    subtree: true
                });
            }
        }
        
        // Setup observer after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupIconObserver);
        } else {
            setupIconObserver();
        }
    
        function loadNotificationCount() {
            fetch('{% url "payroll:notification_count" %}')
                .then(response => response.json())
                .then(data => {
                    updateNotificationBadge(data.unread_count);
                })
                .catch(error => console.error('Error loading notification count:', error));
        }
    
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }
    
        function loadNotifications() {
            fetch('{% url "payroll:notification_dropdown" %}')
                .then(response => response.text())
                .then(html => {
                    const dropdownContent = document.getElementById('notificationDropdownContent');
                    if (dropdownContent) {
                        dropdownContent.innerHTML = html;
                        // Initialize icons only for the newly loaded content
                        initializeIcons();
                    }
                })
                .catch(error => console.error('Error loading notifications:', error));
        }

        function markAsRead(notificationId, redirectUrl = null, event = null) {
            if (event) {
                event.preventDefault();
            }

            const request = fetch(`/payroll/notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                keepalive: true,
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationBadge(data.unread_count);
                    }
                    return data;
                });

            if (redirectUrl) {
                Promise.race([request, new Promise(resolve => setTimeout(resolve, 150))])
                    .finally(() => {
                        window.location.href = redirectUrl;
                    });
                return false;
            }

            request.catch(error => console.error('Error marking notification as read:', error));
            return true;
        }

        function markAllAsRead() {
            fetch('/payroll/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateNotificationBadge(data.unread_count);
                        loadNotifications();
                    }
                })
                .catch(error => console.error('Error marking all notifications as read:', error));
        }
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Expose notification utilities to Alpine expressions and inline handlers.
        window.loadNotifications = loadNotifications;
        window.loadNotificationCount = loadNotificationCount;
        window.markAsRead = markAsRead;
        window.markAllAsRead = markAllAsRead;
        window.updateNotificationCount = updateNotificationBadge;
    })();
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>
