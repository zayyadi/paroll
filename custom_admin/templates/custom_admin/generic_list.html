{% extends "custom_admin/base_admin.html" %}
{% load static %}
{% load admin_tags %} {# Load custom admin_tags for getattr_filter #}

{% block admin_title %}{{ title|default:"List" }} - Custom Admin{% endblock %}

{% block admin_page_header %}
    <div class="flex justify-between items-center">
        <h1 class="text-2xl font-semibold text-gray-800">{{ title|default:"Objects List" }}</h1>
        <a href="{% url 'custom_admin:generic_create' app_label=app_label model_name=model_name %}" 
           class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-700">
            <i data-lucide="plus" class="mr-2 h-5 w-5"></i>Add New {{ model_verbose_name|capfirst }}
        </a>
    </div>
{% endblock %}

{% block admin_content %}
<form method="post" action=""> {# Main form for row actions #}
    {% csrf_token %}

    {% comment %} Action Selection UI - Placed above Search/Filters for now {% endcomment %}
    {% if actions and actions|length > 0 %} {# Check if actions dict is not empty #}
        <div class="my-4 p-3 bg-gray-50 rounded-md border border-gray-200 shadow-sm">
            <div class="flex items-center space-x-3">
                <label for="action-select" class="text-sm font-medium text-gray-700 sr-only">Action:</label> {# Screen-reader only label as visual is clear #}
                <select name="action" id="action-select" 
                        class="block w-auto py-2 pl-3 pr-9 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="" selected>Select an action</option>
                    {% for action_value, action_display_name in actions.items %}
                        <option value="{{ action_value }}">{{ action_display_name }}</option>
                    {% endfor %}
                </select>
                <button type="submit" name="apply_action_button" value="true"
                        class="px-4 py-2 bg-gray-700 text-white text-sm font-medium rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 flex items-center">
                    <i data-lucide="play-circle" class="h-5 w-5 mr-2"></i>Go
                </button>
                <span class="text-sm text-gray-600">
                    <span id="selected-items-count">0</span> selected item(s)
                </span>
            </div>
        </div>
    {% endif %}

    <!-- Search and Filters -->
    <div class="mb-6 p-4 bg-white rounded-lg shadow">
        <form method="get" class="flex items-center space-x-2">
            <input type="text" name="q" value="{{ search_query|default:'' }}" placeholder="Search..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            {# Preserve existing filters when searching #}
            {% for key, value in current_filters.items %}
                {% if value %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center">
                <i data-lucide="search" class="h-5 w-5 mr-2"></i>Search
            </button>
        </form>

        {% if filters_data %}
        <form method="get" class="mt-4">
            <div class="flex flex-wrap items-end gap-4"> {# items-end to align button with bottom of selects #}
                <input type="hidden" name="q" value="{{ search_query|default:'' }}"> {# Preserve search query #}
                {% for filter_item in filters_data %}
                    <div>
                        <label for="filter_{{ filter_item.name }}" class="block text-sm font-medium text-gray-700">{{ filter_item.verbose_name|capfirst }}</label>
                        <select name="{{ filter_item.name }}" id="filter_{{ filter_item.name }}" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" style="min-width: 150px;">
                            <option value="">All</option>
                            {% for val, display in filter_item.options %}
                                <option value="{{ val }}" {% if filter_item.current_value == val|stringformat:"s" %}selected{% endif %}>{{ display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% endfor %}
                <div class="flex space-x-2">
                    <button type="submit" class="px-4 py-2 h-10 bg-gray-600 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">Apply Filters</button>
                    <a href="{% url 'custom_admin:generic_list' app_label=app_label model_name=model_name %}" 
                       class="px-4 py-2 h-10 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Clear</a>
                </div>
            </div>
        </form>
        {% endif %}
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-3 py-3 text-center w-12">
                        <input type="checkbox" id="select-all-checkbox" title="Select all rows"
                               class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-offset-0 focus:ring-indigo-500">
                    </th>
                    {% for field_name in model_fields %}
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            {{ field_name|replace:"_" " "|capfirst }}
                        </th>
                    {% endfor %}
                    <th scope="col" class="px-6 py-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-center">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for object in object_list %}
                    <tr>
                        <td class="px-3 py-4 text-center">
                            <input type="checkbox" name="selected_ids" value="{{ object.pk }}" title="Select row {{ object.pk }}"
                                   class="row-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-offset-0 focus:ring-indigo-500">
                        </td>
                        {% for field_name in model_fields %}
                            {% with value=object|get_field_value:field_name is_boolean=object|is_boolean_field:field_name is_fk_oto=object|is_foreign_key_or_one_to_one_field:field_name is_date=object|is_date_field_filter:field_name is_datetime=object|is_datetime_field_filter:field_name is_numeric=object|is_numeric_field_filter:field_name %}
                                <td class="px-6 py-4 whitespace-nowrap text-sm {% if is_numeric %}text-right text-gray-800{% else %}text-left text-gray-700{% endif %}">
                                    {% if is_boolean %}
                                        <div class="flex justify-center"> {# Center boolean icons regardless of td text-align #}
                                            {% if value is True %}<i data-lucide="check-circle" class="h-5 w-5 text-green-600"></i>
                                            {% elif value is False %}<i data-lucide="x-circle" class="h-5 w-5 text-red-600"></i>
                                            {% else %}<span class="text-gray-400">-</span>{% endif %}
                                        </div>
                                    {% elif is_fk_oto and value %}
                                        {% with edit_url=value|get_custom_admin_edit_url %}
                                            {% if edit_url %}<a href="{{ edit_url }}" class="text-indigo-600 hover:text-indigo-800 hover:underline">{{ value|truncatechars:50|default:"-" }}</a>
                                            {% else %}{{ value|truncatechars:50|default:"-" }}{% endif %}
                                        {% endwith %}
                                    {% elif is_datetime and value %}
                                        {{ value|date:"Y-m-d H:i"|default:"-" }}
                                    {% elif is_date and value %}
                                        {{ value|date:"Y-m-d"|default:"-" }}
                                    {% else %}
                                        {{ value|truncatechars:50|default:"-" }}
                                    {% endif %}
                                </td>
                            {% endwith %}
                        {% endfor %}
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
                            <a href="{% url 'custom_admin:generic_update' app_label=app_label model_name=model_name pk=object.pk %}" 
                               class="text-indigo-600 hover:text-indigo-800 hover:underline focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-1 rounded-sm px-1 py-0.5">Edit</a>
                            <span class="text-gray-300 mx-1">|</span>
                            <a href="{% url 'custom_admin:generic_delete' app_label=app_label model_name=model_name pk=object.pk %}" 
                               class="text-red-600 hover:text-red-800 hover:underline focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-offset-1 rounded-sm px-1 py-0.5">Delete</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                            <td colspan="{{ model_fields|length|add:2 }}" class="px-6 py-4 text-center text-sm text-gray-500"> {# Adjusted colspan #}
                            No {{ model_verbose_name_plural }} found.
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if is_paginated %}
        <div class="mt-6 flex justify-between items-center">
            <div class="text-sm text-gray-700">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
            </div>
            <div class="space-x-1">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-indigo-500">&laquo; First</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-indigo-500">Previous</a>
                {% endif %}
                <span class="px-3 py-1 border border-gray-300 bg-blue-500 text-white rounded-md text-sm">
                    {{ page_obj.number }}
                </span>
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-indigo-500">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 focus:outline-none focus:ring-1 focus:ring-indigo-500">Last &raquo;</a>
                {% endif %}
            </div>
        </div>
    {% endif %}
    <script> 
        // Ensure icons like 'plus' render. This might be redundant if base_admin.html already calls it effectively.
        if (typeof lucide !== 'undefined') {
            lucide.createIcons(); 
        }
    </script>
</form> {# End main form for row actions #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const selectedItemsCountSpan = document.getElementById('selected-items-count');
    
    function updateSelectedCount() {
        if (selectedItemsCountSpan) {
            const count = document.querySelectorAll('.row-checkbox:checked').length;
            selectedItemsCountSpan.textContent = count;
        }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateSelectedCount(); // Update count when select-all changes
        });

        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (!this.checked) {
                    selectAllCheckbox.checked = false;
                } else {
                    let allChecked = true;
                    rowCheckboxes.forEach(cb => {
                        if (!cb.checked) {
                            allChecked = false;
                        }
                    });
                    selectAllCheckbox.checked = allChecked;
                }
                updateSelectedCount(); // Update count when individual checkbox changes
            });
        });
        updateSelectedCount(); // Initial count on page load
    } else if (rowCheckboxes.length > 0) { 
        // Fallback if no select-all, but row checkboxes exist (e.g. if table is empty initially)
        rowCheckboxes.forEach(checkbox => {
             checkbox.addEventListener('change', updateSelectedCount);
         });
        updateSelectedCount(); // Initial count
    } else if (selectedItemsCountSpan) {
        // Ensure count is 0 if no checkboxes at all
        selectedItemsCountSpan.textContent = '0';
    }
});
</script>
{% endblock %}
